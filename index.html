<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Guide Visa Cover Letter Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner{border:4px solid rgba(0,0,0,0.1);width:36px;height:36px;border-radius:50%;border-left-color:#000;animation:spin 1s ease infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .hint{font-size:.8rem}
    .section{border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem}
    .hidden{display:none}
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-1">Visa Application Cover Letter Generator</h1>
      <p class="text-sm text-gray-600">Powered by No Guide Travel Agent • Default currency: ₦</p>
    </header>

    <section id="form-container" class="bg-white shadow-md rounded-xl p-6 space-y-6">
      <form id="visaForm" class="space-y-8">

        <!-- SOP decision flags -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 section">
          <div>
            <label class="block text-sm font-semibold mb-1" for="applicationType">Application Type <span class="text-red-500">*</span></label>
            <select id="applicationType" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="First-time">First-time</option>
              <option value="Reapplication">Reapplication (after refusal)</option>
            </select>
            <p class="hint text-gray-500 mt-1">If reapplying, add refusal reasons.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="employmentStatus">Employment Status <span class="text-red-500">*</span></label>
            <select id="employmentStatus" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option>Employed</option>
              <option>Self-employed</option>
              <option>Unemployed</option>
              <option>Student</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="funding">Funding Source <span class="text-red-500">*</span></label>
            <select id="funding" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option>Self-funded</option>
              <option>Employer</option>
              <option>Family</option>
              <option>Sponsor</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <!-- Applicant Info -->
        <div class="section">
          <h2 class="text-xl font-semibold">Applicant Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="name">Full Name <span class="text-red-500">*</span></label>
              <input id="name" type="text" class="w-full border rounded-md p-2" required />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="age">Age <span class="text-red-500">*</span></label>
                <input id="age" type="number" min="0" class="w-full border rounded-md p-2" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="nationality">Nationality <span class="text-red-500">*</span></label>
                <input id="nationality" type="text" class="w-full border rounded-md p-2" required />
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="applicantAddress">Address</label>
              <input id="applicantAddress" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactPhone">Phone</label>
              <input id="contactPhone" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactEmail">Email</label>
              <input id="contactEmail" type="email" class="w-full border rounded-md p-2" />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" for="dateOfBirth">Date of Birth</label>
              <input id="dateOfBirth" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportNumber">Passport Number</label>
              <input id="passportNumber" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportIssueDate">Passport Issue Date</label>
              <input id="passportIssueDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportExpiryDate">Passport Expiry Date</label>
              <input id="passportExpiryDate" type="date" class="w-full border rounded-md p-2" />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" for="maritalStatus">Marital Status</label>
              <select id="maritalStatus" class="w-full border rounded-md p-2">
                <option value="">Select</option>
                <option>Single</option><option>Married</option><option>Divorced</option>
                <option>Widowed</option><option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="numDependents">Number of Dependents</label>
              <input id="numDependents" type="number" min="0" class="w-full border rounded-md p-2" />
            </div>
          </div>
        </div>

        <!-- Travel & Visa -->
        <div class="section">
          <h2 class="text-xl font-semibold">Travel & Visa Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="destination">Destination Country <span class="text-red-500">*</span></label>
              <input id="destination" type="text" class="w-full border rounded-md p-2" placeholder="United Kingdom" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="visaType">Visa Type <span class="text-red-500">*</span></label>
              <select id="visaType" class="w-full border rounded-md p-2" required>
                <option value="">Select</option>
                <option>Tourist</option><option>Business</option><option>Study</option>
                <option>Medical</option><option>Visit</option><option>Other</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="purpose">Purpose of Travel <span class="text-red-500">*</span></label>
              <textarea id="purpose" rows="2" class="w-full border rounded-md p-2" required placeholder="Tourism, visiting family, conference, medical treatment, study, etc."></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" for="travelDates">Travel Dates</label>
              <input id="travelDates" type="text" class="w-full border rounded-md p-2" placeholder="10 Oct – 20 Oct 2025" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="entryDate">Planned Date of Entry</label>
              <input id="entryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDuration">Duration of Stay</label>
              <input id="stayDuration" type="text" class="w-full border rounded-md p-2" placeholder="10 days" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="invited">Invited by someone there?</label>
              <select id="invited" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="stayDetails">Accommodation / Host Details</label>
              <textarea id="stayDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hotel info or host address"></textarea>
            </div>

            <!-- Inviter mini -->
            <div>
              <label class="block text-sm font-medium mb-1" for="inviterName">Inviter's Name</label>
              <input id="inviterName" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="inviterAddress">Inviter's Address</label>
              <input id="inviterAddress" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="inviterRelationship">Inviter's Relationship</label>
              <input id="inviterRelationship" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="inviterDocs">Inviter's Supporting Documents</label>
              <input id="inviterDocs" type="text" class="w-full border rounded-md p-2" placeholder="Invitation letter, passport, BRP" />
            </div>
          </div>

          <!-- Purpose-specific blocks -->
          <div id="touristBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Tourist Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="touristHighlights">Planned Highlights / Itinerary</label>
                <textarea id="touristHighlights" rows="2" class="w-full border rounded-md p-2" placeholder="Cities, attractions, activities"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="touristCompanions">Travelling with (names/relationship)</label>
                <input id="touristCompanions" type="text" class="w-full border rounded-md p-2" />
              </div>
            </div>
          </div>

          <div id="businessBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Business / Conference Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="businessEvent">Event / Meeting Name</label>
                <input id="businessEvent" type="text" class="w-full border rounded-md p-2" placeholder="Conference/Training/Meeting" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="businessDates">Event Dates</label>
                <input id="businessDates" type="text" class="w-full border rounded-md p-2" placeholder="e.g., 15–18 Nov 2025" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1" for="businessCoverage">Who covers the costs?</label>
                <input id="businessCoverage" type="text" class="w-full border rounded-md p-2" placeholder="Company/self/sponsor" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1" for="businessInviteRef">Invitation / Reference (if any)</label>
                <input id="businessInviteRef" type="text" class="w-full border rounded-md p-2" />
              </div>
            </div>
          </div>

          <div id="studyBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Study Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="schoolName">School / Department</label>
                <input id="schoolName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="courseTitle">Course / Program</label>
                <input id="courseTitle" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="courseLength">Course Length</label>
                <input id="courseLength" type="text" class="w-full border rounded-md p-2" placeholder="e.g., 3 months" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="acceptanceRef">Acceptance Letter (date/ref)</label>
                <input id="acceptanceRef" type="text" class="w-full border rounded-md p-2" />
              </div>
            </div>
          </div>

          <div id="medicalBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Medical Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="hospitalName">Hospital / Clinic</label>
                <input id="hospitalName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="doctorName">Doctor / Department</label>
                <input id="doctorName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="appointmentWindow">Appointment Date / Window</label>
                <input id="appointmentWindow" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="treatmentEstimate">Treatment Cost Estimate (₦)</label>
                <input id="treatmentEstimate" type="text" class="w-full border rounded-md p-2" placeholder="₦" />
              </div>
            </div>
          </div>

          <div id="visitBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Visit Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="visitHost">Host Name & Relationship</label>
                <input id="visitHost" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="visitOccasion">Occasion / Reason</label>
                <input id="visitOccasion" type="text" class="w-full border rounded-md p-2" />
              </div>
            </div>
          </div>

          <div id="visaOtherBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Other Visa Type</h3>
            <textarea id="visaOtherText" rows="2" class="w-full border rounded-md p-2" placeholder="Describe the visa type and purpose"></textarea>
          </div>
        </div>

        <!-- Employment & Finances -->
        <div class="section">
          <h2 class="text-xl font-semibold">Employment & Finances</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="occupation">Occupation / Employer</label>
              <input id="occupation" type="text" class="w-full border rounded-md p-2" placeholder="e.g., Software Developer at XYZ Ltd." />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="income">Monthly Income (₦) <span class="text-red-500">*</span></label>
              <input id="income" type="text" class="w-full border rounded-md p-2" placeholder="₦750,000" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="monthlyExpenses">Monthly Expenses (₦)</label>
              <input id="monthlyExpenses" type="text" class="w-full border rounded-md p-2" placeholder="₦300,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="currentBankBalance">Current Bank Balance (₦)</label>
              <input id="currentBankBalance" type="text" class="w-full border rounded-md p-2" placeholder="₦5,600,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="estimatedTripCost">Estimated Trip Cost (₦ or £)</label>
              <input id="estimatedTripCost" type="text" class="w-full border rounded-md p-2" placeholder="₦1,800,000 or £2,000" />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="bankStatementDetails">Bank Statement Details</label>
              <textarea id="bankStatementDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Bank name, statement window, balance trend"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="significantTransactions">Significant Transactions / Lump Sums</label>
              <textarea id="significantTransactions" rows="2" class="w-full border rounded-md p-2" placeholder="Explain any large or irregular transactions"></textarea>
            </div>
          </div>

          <!-- Funding-specific blocks -->
          <div id="employerFundingBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Employer Funding Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="employerCovers">What will employer cover?</label>
                <input id="employerCovers" type="text" class="w-full border rounded-md p-2" placeholder="Flights, accommodation, fees…" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="leaveApproval">Leave Approval (date/ref)</label>
                <input id="leaveApproval" type="text" class="w-full border rounded-md p-2" />
              </div>
            </div>
          </div>

          <div id="familyFundingBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Family Funding Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="familyPayer">Payer's Name & Relationship</label>
                <input id="familyPayer" type="text" class="w-full border rounded-md p-2" placeholder="e.g., Father – Mr. Adewale" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="familyProof">Proof / Docs</label>
                <input id="familyProof" type="text" class="w-full border rounded-md p-2" placeholder="Bank statements, letter of support" />
              </div>
            </div>
          </div>

          <div id="sponsorBlock" class="hidden mt-4">
            <h3 class="text-xl font-semibold">Sponsor Information</h3>
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="sponsorName">Sponsor's Name <span class="text-red-500">*</span></label>
                <input id="sponsorName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="sponsorRelationship">Sponsor's Relationship <span class="text-red-500">*</span></label>
                <input id="sponsorRelationship" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="sponsorOccupation">Sponsor's Occupation</label>
                <input id="sponsorOccupation" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="sponsorIncome">Sponsor's Income (₦)</label>
                <input id="sponsorIncome" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="sponsorAccommodation">Will Sponsor Provide Accommodation?</label>
                <select id="sponsorAccommodation" class="w-full border rounded-md p-2">
                  <option value="">Select</option><option>Yes</option><option>No</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1" for="sponsorDocs">Sponsor's Documents</label>
                <textarea id="sponsorDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Bank statements, payslips, invitation letter"></textarea>
              </div>
            </div>
          </div>

          <div id="fundingOtherBlock" class="hidden mt-4">
            <h3 class="font-semibold mb-2">Other Funding Source</h3>
            <textarea id="fundingOtherText" rows="2" class="w-full border rounded-md p-2" placeholder="Describe who funds and how"></textarea>
          </div>

          <div id="financeCalc" class="mt-3 text-sm text-gray-700 hidden"></div>
        </div>

        <!-- Consular -->
        <div class="section">
          <h2 class="text-xl font-semibold">Consular Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyName">Embassy Name</label>
              <input id="embassyName" type="text" class="w-full border rounded-md p-2" placeholder="The British Deputy High Commissioner" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyAddress">Embassy Address</label>
              <input id="embassyAddress" type="text" class="w-full border rounded-md p-2" placeholder="11 Walter Carrington Crescent, VI, Lagos" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="companyName">Company Name (branding)</label>
              <input id="companyName" type="text" class="w-full border rounded-md p-2" value="No Guide Travel Agent" />
            </div>
          </div>
        </div>

        <!-- Ties -->
        <div class="section">
          <h2 class="text-xl font-semibold">Ties to Nigeria & Commitments</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="propertyDetails">Property Ownership</label>
              <textarea id="propertyDetails" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="businessCommitments">Business / Employment Commitments</label>
              <textarea id="businessCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="familyDependents">Family / Dependents</label>
              <textarea id="familyDependents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="otherCommitments">Other Commitments</label>
              <textarea id="otherCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="section">
          <h2 class="text-xl font-semibold">Travel & Visa History</h2>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="travelHistory">Past Travel History</label>
            <textarea id="travelHistory" rows="2" class="w-full border rounded-md p-2" placeholder="Countries visited + dates"></textarea>
          </div>
          <div id="refusalBlock" class="mt-3 hidden">
            <label class="block text-sm font-medium mb-1" for="visaRefusals">Previous Visa Refusals (reasons & date)</label>
            <textarea id="visaRefusals" rows="2" class="w-full border rounded-md p-2" placeholder="List refusal reasons; attach refs in docs"></textarea>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="validVisas">Current Valid Visas</label>
            <textarea id="validVisas" rows="2" class="w-full border rounded-md p-2"></textarea>
          </div>
        </div>

        <!-- Additional -->
        <div class="section">
          <h2 class="text-xl font-semibold">Additional Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="specialEvents">Special Events / Highlights</label>
              <textarea id="specialEvents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="compellingReasons">Compelling Personal Reasons</label>
              <textarea id="compellingReasons" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="supportingLetters">Supporting Letters/Documents</label>
              <textarea id="supportingLetters" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="potentialWeaknesses">Potential Weaknesses to Explain</label>
              <textarea id="potentialWeaknesses" rows="2" class="w-full border rounded-md p-2" placeholder="e.g., low balance, new account, gaps in employment"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="pt-2 flex items-center gap-4">
          <button id="generateBtn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:pointer-events-none">Generate Letter</button>
          <div id="spinner" class="spinner hidden"></div>
          <p id="statusMsg" class="text-sm text-gray-600"></p>
        </div>
      </form>
    </section>

    <section id="output-section" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Letter</h2>
      <textarea id="output" class="w-full h-64 border rounded-md p-3 bg-gray-100" readonly></textarea>
      <div class="mt-3 flex flex-wrap gap-3">
        <button id="copyBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Copy to Clipboard</button>
        <button id="downloadBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Download as DOC</button>
        <button id="printBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Print Letter</button>
      </div>
    </section>
  </main>

  <script>
    // --- Elements ---
    const form = document.getElementById('visaForm');
    const spinner = document.getElementById('spinner');
    const statusMsg = document.getElementById('statusMsg');
    const outputSection = document.getElementById('output-section');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');

    const applicationType = document.getElementById('applicationType');
    const employmentStatus = document.getElementById('employmentStatus');
    const funding = document.getElementById('funding');
    const visaType = document.getElementById('visaType');

    const refusalBlock = document.getElementById('refusalBlock');

    // Purpose blocks
    const touristBlock = document.getElementById('touristBlock');
    const businessBlock = document.getElementById('businessBlock');
    const studyBlock = document.getElementById('studyBlock');
    const medicalBlock = document.getElementById('medicalBlock');
    const visitBlock = document.getElementById('visitBlock');
    const visaOtherBlock = document.getElementById('visaOtherBlock');

    // Funding blocks
    const employerFundingBlock = document.getElementById('employerFundingBlock');
    const familyFundingBlock = document.getElementById('familyFundingBlock');
    const sponsorBlock = document.getElementById('sponsorBlock');
    const fundingOtherBlock = document.getElementById('fundingOtherBlock');

    // Finance calc
    const monthlyExpenses = document.getElementById('monthlyExpenses');
    const currentBankBalance = document.getElementById('currentBankBalance');
    const estimatedTripCost = document.getElementById('estimatedTripCost');
    const financeCalc = document.getElementById('financeCalc');

    // --- Conditional UI ---
    applicationType.addEventListener('change', () => {
      refusalBlock.classList.toggle('hidden', applicationType.value !== 'Reapplication');
    });

    visaType.addEventListener('change', () => {
      const v = visaType.value;
      touristBlock.classList.toggle('hidden', v !== 'Tourist');
      businessBlock.classList.toggle('hidden', v !== 'Business');
      studyBlock.classList.toggle('hidden', v !== 'Study');
      medicalBlock.classList.toggle('hidden', v !== 'Medical');
      visitBlock.classList.toggle('hidden', v !== 'Visit');
      visaOtherBlock.classList.toggle('hidden', v !== 'Other');
    });

    funding.addEventListener('change', () => {
      const f = funding.value;
      employerFundingBlock.classList.toggle('hidden', f !== 'Employer');
      familyFundingBlock.classList.toggle('hidden', f !== 'Family');
      sponsorBlock.classList.toggle('hidden', f !== 'Sponsor');
      fundingOtherBlock.classList.toggle('hidden', f !== 'Other');
    });

    // --- Helpers ---
    function v(id){ return document.getElementById(id)?.value?.trim() || '' }
    function num(x){
      if(!x) return NaN;
      const s = (''+x).replace(/[^0-9.\-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? NaN : n;
    }

    // Live finance calculation
    [monthlyExpenses, estimatedTripCost, currentBankBalance, document.getElementById('income')].forEach(el=>{
      el.addEventListener('input', showFinance);
    });
    function showFinance(){
      const income = num(v('income'));
      const expenses = num(v('monthlyExpenses'));
      const trip = num(v('estimatedTripCost'));
      const balance = num(v('currentBankBalance'));

      if(isNaN(income) && isNaN(expenses) && isNaN(trip) && isNaN(balance)){
        financeCalc.classList.add('hidden'); financeCalc.textContent=''; return;
      }
      const disp = (isNaN(income)?0:income) - (isNaN(expenses)?0:expenses);
      const ratio = isNaN(trip) || disp<=0 ? null : (trip/disp);
      const remain = isNaN(balance) || isNaN(trip) ? null : (balance - trip);

      financeCalc.classList.remove('hidden');
      financeCalc.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
          <div><span class="font-semibold">Disposable Income (₦ approx):</span> ${isNaN(disp)?'—':disp.toLocaleString()}</div>
          <div><span class="font-semibold">Trip/Disposable Ratio:</span> ${ratio===null?'—':ratio.toFixed(2)} ${ratio!==null? (ratio<=1?'(Affordable within ~1 month)':'(May need sponsor/assets)'):''}</div>
          <div><span class="font-semibold">Balance after Trip (₦ approx):</span> ${remain===null?'—':remain.toLocaleString()}</div>
        </div>
      `;
    }

    // Build payload for backend
    function getFormData(){
      // Blend purpose-specific details into a narrative we send as fields the backend already understands.
      const purposeExtras = [];

      switch(visaType.value){
        case 'Tourist':
          if(v('touristHighlights')) purposeExtras.push(`Tourist plan: ${v('touristHighlights')}`);
          if(v('touristCompanions')) purposeExtras.push(`Travelling with: ${v('touristCompanions')}`);
          break;
        case 'Business':
          if(v('businessEvent')) purposeExtras.push(`Business event: ${v('businessEvent')}`);
          if(v('businessDates')) purposeExtras.push(`Event dates: ${v('businessDates')}`);
          if(v('businessCoverage')) purposeExtras.push(`Costs covered by: ${v('businessCoverage')}`);
          if(v('businessInviteRef')) purposeExtras.push(`Invitation ref: ${v('businessInviteRef')}`);
          break;
        case 'Study':
          if(v('schoolName')) purposeExtras.push(`School: ${v('schoolName')}`);
          if(v('courseTitle')) purposeExtras.push(`Course: ${v('courseTitle')}`);
          if(v('courseLength')) purposeExtras.push(`Course length: ${v('courseLength')}`);
          if(v('acceptanceRef')) purposeExtras.push(`Acceptance: ${v('acceptanceRef')}`);
          break;
        case 'Medical':
          if(v('hospitalName')) purposeExtras.push(`Hospital: ${v('hospitalName')}`);
          if(v('doctorName')) purposeExtras.push(`Doctor/Dept: ${v('doctorName')}`);
          if(v('appointmentWindow')) purposeExtras.push(`Appointment: ${v('appointmentWindow')}`);
          if(v('treatmentEstimate')) purposeExtras.push(`Treatment estimate: ${v('treatmentEstimate')}`);
          break;
        case 'Visit':
          if(v('visitHost')) purposeExtras.push(`Host: ${v('visitHost')}`);
          if(v('visitOccasion')) purposeExtras.push(`Occasion: ${v('visitOccasion')}`);
          break;
        case 'Other':
          if(v('visaOtherText')) purposeExtras.push(`Other visa type: ${v('visaOtherText')}`);
          break;
      }

      // Funding extras
      const fundingExtras = [];
      if(funding.value==='Employer'){
        if(v('employerCovers')) fundingExtras.push(`Employer covers: ${v('employerCovers')}`);
        if(v('leaveApproval')) fundingExtras.push(`Leave approval: ${v('leaveApproval')}`);
      } else if(funding.value==='Family'){
        if(v('familyPayer')) fundingExtras.push(`Family payer: ${v('familyPayer')}`);
        if(v('familyProof')) fundingExtras.push(`Family proof: ${v('familyProof')}`);
      } else if(funding.value==='Other'){
        if(v('fundingOtherText')) fundingExtras.push(`Other funding: ${v('fundingOtherText')}`);
      }

      // Finance synthesis appended to bankStatementDetails
      const bankBits = [];
      if(v('income')) bankBits.push(`Monthly Income: ${v('income')}`);
      if(v('monthlyExpenses')) bankBits.push(`Monthly Expenses: ${v('monthlyExpenses')}`);
      if(v('currentBankBalance')) bankBits.push(`Current Bank Balance: ${v('currentBankBalance')}`);
      if(v('estimatedTripCost')) bankBits.push(`Estimated Trip Cost: ${v('estimatedTripCost')}`);
      const bankSynth = [v('bankStatementDetails'), bankBits.join(' • '), fundingExtras.join(' • ')]
                        .filter(Boolean).join('\n');

      return {
        // Personal
        name: v('name'),
        age: v('age'),
        nationality: v('nationality'),
        applicantAddress: v('applicantAddress'),
        contactPhone: v('contactPhone'),
        contactEmail: v('contactEmail'),
        dateOfBirth: v('dateOfBirth'),
        passportNumber: v('passportNumber'),
        passportIssueDate: v('passportIssueDate'),
        passportExpiryDate: v('passportExpiryDate'),
        maritalStatus: v('maritalStatus'),
        numDependents: v('numDependents'),

        // Travel
        destination: v('destination'),
        visaType: v('visaType'),
        purpose: v('purpose'),
        travelDates: v('travelDates'),
        entryDate: v('entryDate'),
        stayDuration: v('stayDuration'),
        invited: v('invited'),
        inviterName: v('inviterName'),
        inviterAddress: v('inviterAddress'),
        inviterRelationship: v('inviterRelationship'),
        inviterDocs: v('inviterDocs'),
        stayDetails: v('stayDetails'),

        // Employment & finances
        occupation: v('occupation'),
        income: v('income'),
        monthlyExpenses: v('monthlyExpenses'),
        currentBankBalance: v('currentBankBalance'),
        estimatedTripCost: v('estimatedTripCost'),
        funding: v('funding'),
        bankStatementDetails: bankSynth,
        significantTransactions: v('significantTransactions'),

        // Consular / branding
        embassyName: v('embassyName'),
        embassyAddress: v('embassyAddress'),
        companyName: v('companyName') || 'No Guide Travel Agent',

        // Ties
        propertyDetails: v('propertyDetails'),
        businessCommitments: v('businessCommitments'),
        familyDependents: v('familyDependents'),
        otherCommitments: v('otherCommitments'),

        // History
        travelHistory: v('travelHistory'),
        visaRefusals: (applicationType.value==='Reapplication' ? (v('visaRefusals') || 'Refusal stated but details not provided') : v('visaRefusals')),
        validVisas: v('validVisas'),

        // Sponsor (visible only when funding === 'Sponsor')
        sponsorSelf: (funding.value==='Sponsor' ? 'No' : (funding.value==='Self-funded' ? 'Yes' : '')),
        sponsorName: v('sponsorName'),
        sponsorRelationship: v('sponsorRelationship'),
        sponsorOccupation: v('sponsorOccupation'),
        sponsorIncome: v('sponsorIncome'),
        sponsorAccommodation: v('sponsorAccommodation'),
        sponsorDocs: v('sponsorDocs'),

        // Additional
        specialEvents: [v('specialEvents'), purposeExtras.join(' • ')].filter(Boolean).join('\n'),
        compellingReasons: v('compellingReasons'),
        supportingLetters: v('supportingLetters'),
        potentialWeaknesses: v('potentialWeaknesses')
      };
    }

    function validateForm(data){
      const missing = [];
      if(!data.name) missing.push('Name');
      if(!data.age) missing.push('Age');
      if(!data.nationality) missing.push('Nationality');
      if(!data.destination) missing.push('Destination Country');
      if(!visaType.value) missing.push('Visa Type');
      if(!data.purpose) missing.push('Purpose of Travel');
      if(!data.income) missing.push('Monthly Income');
      if(!applicationType.value) missing.push('Application Type');
      if(!employmentStatus.value) missing.push('Employment Status');
      if(!funding.value) missing.push('Funding Source');

      // Conditional requirements
      if(applicationType.value==='Reapplication' && !v('visaRefusals')){
        missing.push('Refusal Reasons');
      }
      if(funding.value==='Sponsor'){
        if(!v('sponsorName')) missing.push('Sponsor Name');
        if(!v('sponsorRelationship')) missing.push('Sponsor Relationship');
      }
      if(visaType.value==='Business' && !v('businessEvent')){
        missing.push('Business Event Name');
      }
      if(visaType.value==='Medical' && !v('hospitalName')){
        missing.push('Hospital/Clinic');
      }
      if(visaType.value==='Study' && !v('schoolName')){
        missing.push('School/Department');
      }
      if(visaType.value==='Visit' && !v('visitHost')){
        missing.push('Visit Host');
      }
      if(visaType.value==='Other' && !v('visaOtherText')){
        missing.push('Other Visa Type Description');
      }
      if(funding.value==='Other' && !v('fundingOtherText')){
        missing.push('Other Funding Description');
      }
      return missing;
    }

    async function generateLetter(payload){
      const response = await fetch('https://visa-cover-letter-api.onrender.com/generate-letter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!response.ok){
        const errorData = await response.json().catch(()=>null);
        throw new Error(errorData?.error || 'Unexpected server error');
      }
      const data = await response.json();
      return data.letter;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusMsg.classList.remove('text-green-600','text-red-600');
      const payload = getFormData();
      const missing = validateForm(payload);
      if(missing.length){
        statusMsg.textContent = `Missing required fields: ${missing.join(', ')}`;
        statusMsg.classList.add('text-red-600');
        return;
      }
      spinner.classList.remove('hidden');
      e.target.querySelector('button[type="submit"]').disabled = true;
      try{
        const letter = await generateLetter(payload);
        output.value = letter;
        outputSection.classList.remove('hidden');
        statusMsg.textContent = 'Letter generated successfully';
        statusMsg.classList.add('text-green-600');
      }catch(err){
        console.error(err);
        statusMsg.textContent = err.message || 'Failed to generate letter';
        statusMsg.classList.add('text-red-600');
      }finally{
        spinner.classList.add('hidden');
        e.target.querySelector('button[type="submit"]').disabled = false;
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.value); alert('Letter copied to clipboard'); }
      catch{ alert('Could not copy'); }
    });

    downloadBtn.addEventListener('click', ()=>{
      const blob = new Blob([output.value], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'visa_cover_letter.doc';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    printBtn.addEventListener('click', ()=>{
      const win = window.open('', '_blank'); if(!win) return;
      win.document.write(`<!doctype html><html><head><title>Visa Cover Letter</title></head><body style="white-space: pre-wrap; font-family: serif; margin: 40px;">${
        output.value.replace(/</g,'&lt;').replace(/>/g,'&gt;')
      }</body></html>`); win.document.close(); win.focus(); win.print();
    });
  </script>
</body>
</html>
