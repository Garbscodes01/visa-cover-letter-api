<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Guide Visa Cover Letter Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner{border:4px solid rgba(0,0,0,0.1);width:36px;height:36px;border-radius:50%;border-left-color:#000;animation:spin 1s ease infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .hint{font-size:.8rem}
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-1">Visa Application Cover Letter Generator</h1>
      <p class="text-sm text-gray-600">Powered by No Guide Travel Agent</p>
    </header>

    <section id="form-container" class="bg-white shadow-md rounded-xl p-6 space-y-6">
      <form id="visaForm" class="space-y-6">
        <!-- SOP flags -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1" for="applicationType">Application Type <span class="text-red-500">*</span></label>
            <select id="applicationType" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="First-time">First-time</option>
              <option value="Reapplication">Reapplication (after refusal)</option>
            </select>
            <p class="hint text-gray-500 mt-1">If reapplying, add refusal reasons below.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="employmentStatus">Employment Status <span class="text-red-500">*</span></label>
            <select id="employmentStatus" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="Employed">Employed</option>
              <option value="Self-employed">Self-employed</option>
              <option value="Unemployed">Unemployed</option>
              <option value="Student">Student</option>
            </select>
          </div>
        </div>

        <!-- Refusal reasons (top, so staff sees it early) -->
        <div id="refusalBlockTop" class="hidden">
          <label class="block text-sm font-medium mb-1" for="visaRefusalsTop">Previous Visa Refusal(s) — reasons & date</label>
          <textarea id="visaRefusalsTop" rows="2" class="w-full border rounded-md p-2" placeholder="List refusal reasons briefly and date(s)."></textarea>
        </div>

        <!-- Applicant Information -->
        <div>
          <h2 class="text-xl font-semibold">Applicant Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="name">Full Name <span class="text-red-500">*</span></label>
              <input id="name" type="text" class="w-full border rounded-md p-2" required />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="age">Age <span class="text-red-500">*</span></label>
                <input id="age" type="number" min="0" class="w-full border rounded-md p-2" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="nationality">Nationality <span class="text-red-500">*</span></label>
                <input id="nationality" type="text" class="w-full border rounded-md p-2" required />
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="applicantAddress">Address</label>
              <input id="applicantAddress" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactPhone">Phone</label>
              <input id="contactPhone" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactEmail">Email</label>
              <input id="contactEmail" type="email" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="dateOfBirth">Date of Birth</label>
              <input id="dateOfBirth" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportNumber">Passport Number</label>
              <input id="passportNumber" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportIssueDate">Passport Issue Date</label>
              <input id="passportIssueDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportExpiryDate">Passport Expiry Date</label>
              <input id="passportExpiryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="maritalStatus">Marital Status</label>
              <select id="maritalStatus" class="w-full border rounded-md p-2">
                <option value="">Select</option>
                <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option><option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="numDependents">Number of Dependents</label>
              <input id="numDependents" type="number" min="0" class="w-full border rounded-md p-2" />
            </div>
          </div>
        </div>

        <!-- Travel & Visa Details -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="destination">Destination Country <span class="text-red-500">*</span></label>
              <input id="destination" type="text" class="w-full border rounded-md p-2" placeholder="United Kingdom" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="visaType">Visa Type <span class="text-red-500">*</span></label>
              <select id="visaType" class="w-full border rounded-md p-2" required>
                <option value="">Select</option>
                <option>Tourist</option><option>Business</option><option>Study</option>
                <option>Medical</option><option>Visit</option><option>Other</option>
              </select>
            </div>
            <!-- Visa Type: Other specify -->
            <div id="visaTypeOtherWrap" class="hidden md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="visaTypeOther">Please specify (Visa Type = Other)</label>
              <input id="visaTypeOther" type="text" class="w-full border rounded-md p-2" placeholder="Describe the visa type" />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="purpose">Purpose of Travel <span class="text-red-500">*</span></label>
              <textarea id="purpose" rows="2" class="w-full border rounded-md p-2" required placeholder="Tourism, visiting family, conference, medical treatment, etc."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="travelDates">Travel Dates</label>
              <input id="travelDates" type="text" class="w-full border rounded-md p-2" placeholder="10 Oct – 20 Oct 2025" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="entryDate">Planned Date of Entry</label>
              <input id="entryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDuration">Duration of Stay</label>
              <input id="stayDuration" type="text" class="w-full border rounded-md p-2" placeholder="10 days" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="invited">Invited by someone there?</label>
              <select id="invited" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" for="stayDetails">Accommodation / Host Details</label>
              <textarea id="stayDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hotel info or host address"></textarea>
            </div>

            <!-- Inviter fields (auto-hide when invited = No) -->
            <div id="inviterWrap" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterName">Inviter's Name</label>
                <input id="inviterName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterAddress">Inviter's Address</label>
                <input id="inviterAddress" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterRelationship">Inviter's Relationship</label>
                <input id="inviterRelationship" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterDocs">Inviter's Supporting Documents</label>
                <input id="inviterDocs" type="text" class="w-full border rounded-md p-2" placeholder="Invitation letter, passport, BRP" />
              </div>
            </div>
          </div>

          <!-- Purpose-specific details -->
          <div id="businessBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Business/Conference Details</label>
            <textarea id="businessDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Conference name, dates, invitation, who pays"></textarea>
          </div>
          <div id="medicalBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Medical Details</label>
            <textarea id="medicalDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hospital name, appointment window, who covers costs"></textarea>
          </div>
        </div>

        <!-- Employment & Finances -->
        <div>
          <h2 class="text-xl font-semibold">Employment & Finances</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="occupation">Occupation / Employer</label>
              <input id="occupation" type="text" class="w-full border rounded-md p-2" placeholder="Software Developer at XYZ Ltd." />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="income">Monthly Income (₦) <span class="text-red-500">*</span></label>
              <input id="income" type="text" class="w-full border rounded-md p-2" placeholder="₦750,000" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="monthlyExpenses">Monthly Expenses (₦)</label>
              <input id="monthlyExpenses" type="text" class="w-full border rounded-md p-2" placeholder="₦300,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="currentBankBalance">Current Bank Balance (₦)</label>
              <input id="currentBankBalance" type="text" class="w-full border rounded-md p-2" placeholder="₦5,600,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="estimatedTripCost">Estimated Trip Cost (₦ or £)</label>
              <input id="estimatedTripCost" type="text" class="w-full border rounded-md p-2" placeholder="₦2,000,000 or £2,000" />
            </div>

            <!-- The ONLY switch: Funding Source -->
            <div>
              <label class="block text-sm font-medium mb-1" for="funding">Funding Source</label>
              <select id="funding" class="w-full border rounded-md p-2">
                <option value="">Self-funded</option>
                <option>Employer</option><option>Family</option><option>Sponsor</option><option>Other</option>
              </select>
            </div>

            <!-- Funding = Other -->
            <div id="fundingOtherWrap" class="hidden md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="fundingOther">Please specify (Funding = Other)</label>
              <input id="fundingOther" type="text" class="w-full border rounded-md p-2" placeholder="Describe the funding arrangement (name, relationship/company, proof)" />
            </div>

            <!-- FAMILY block -->
            <div id="familyBlock" class="hidden md:col-span-2">
              <h3 class="font-semibold mb-2">Family Sponsor Details</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1" for="familyName">Family Member’s Name</label>
                  <input id="familyName" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="familyRelationship">Relationship to Applicant</label>
                  <input id="familyRelationship" type="text" class="w-full border rounded-md p-2" placeholder="e.g., Father, Sister" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="familyOccupation">Family Member’s Occupation</label>
                  <input id="familyOccupation" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="familyIncome">Family Member’s Income (₦)</label>
                  <input id="familyIncome" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="familyAccommodation">Will Family Provide Accommodation?</label>
                  <select id="familyAccommodation" class="w-full border rounded-md p-2">
                    <option value="">Select</option><option>Yes</option><option>No</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-1" for="familyDocs">Family Sponsor Documents</label>
                  <textarea id="familyDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Bank statements, ID, letter of sponsorship, proof of relationship"></textarea>
                </div>
              </div>
            </div>

            <!-- EMPLOYER block -->
            <div id="employerBlock" class="hidden md:col-span-2">
              <h3 class="font-semibold mb-2">Employer Funding Details</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1" for="employerName2">Company Name</label>
                  <input id="employerName2" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="employerContact">Company Contact / HR</label>
                  <input id="employerContact" type="text" class="w-full border rounded-md p-2" placeholder="Name & phone/email" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="employerCovers">What costs will the company cover?</label>
                  <input id="employerCovers" type="text" class="w-full border rounded-md p-2" placeholder="e.g., flight, hotel, daily allowance" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="employerAccommodation">Will Employer Provide Accommodation?</label>
                  <select id="employerAccommodation" class="w-full border rounded-md p-2">
                    <option value="">Select</option><option>Yes</option><option>No</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-1" for="employerDocs">Employer Documents</label>
                  <textarea id="employerDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Intro/undertaking letter, invitation, CAC/registration, bank proof"></textarea>
                </div>
              </div>
            </div>

            <!-- SPONSOR (non-family individual or organization) -->
            <div id="sponsorBlock" class="hidden md:col-span-2">
              <h3 class="font-semibold mb-2">Sponsor Details</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1" for="sponsorName">Sponsor’s Full Name / Organization</label>
                  <input id="sponsorName" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="sponsorRelationship">Relationship to Applicant</label>
                  <input id="sponsorRelationship" type="text" class="w-full border rounded-md p-2" placeholder="e.g., Family friend / Church / NGO" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="sponsorOccupation">Sponsor Occupation / Nature of Business</label>
                  <input id="sponsorOccupation" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="sponsorIncome">Sponsor’s Income (₦)</label>
                  <input id="sponsorIncome" type="text" class="w-full border rounded-md p-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1" for="sponsorAccommodation">Will Sponsor Provide Accommodation?</label>
                  <select id="sponsorAccommodation" class="w-full border rounded-md p-2">
                    <option value="">Select</option><option>Yes</option><option>No</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium mb-1" for="sponsorDocs">Sponsor Documents</label>
                  <textarea id="sponsorDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Bank statements, ID/registration, letter of sponsorship, invitation"></textarea>
                </div>
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="bankStatementDetails">Bank Statement Details (Applicant)</label>
              <textarea id="bankStatementDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Bank name, balance trend"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="significantTransactions">Significant Transactions / Lump Sums</label>
              <textarea id="significantTransactions" rows="2" class="w-full border rounded-md p-2" placeholder="Explain large/irregular transactions"></textarea>
            </div>
          </div>
          <div id="financeCalc" class="mt-2 text-sm text-gray-700 hidden"></div>
        </div>

        <!-- Consular details -->
        <div>
          <h2 class="text-xl font-semibold">Consular Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyName">Embassy Name</label>
              <input id="embassyName" type="text" class="w-full border rounded-md p-2" placeholder="The British Deputy High Commissioner" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyAddress">Embassy Address</label>
              <input id="embassyAddress" type="text" class="w-full border rounded-md p-2" placeholder="11 Walter Carrington Crescent, VI, Lagos" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="companyName">Company Name (branding)</label>
              <input id="companyName" type="text" class="w-full border rounded-md p-2" value="No Guide Travel Agent" />
            </div>
          </div>
        </div>

        <!-- Ties & commitments -->
        <div>
          <h2 class="text-xl font-semibold">Ties to Nigeria & Commitments</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="propertyDetails">Property Ownership</label>
              <textarea id="propertyDetails" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="businessCommitments">Business / Employment Commitments</label>
              <textarea id="businessCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="familyDependents">Family / Dependents</label>
              <textarea id="familyDependents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="otherCommitments">Other Commitments</label>
              <textarea id="otherCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
          </div>
        </div>

        <!-- Travel & visa history -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa History</h2>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="travelHistory">Past Travel History</label>
            <textarea id="travelHistory" rows="2" class="w-full border rounded-md p-2" placeholder="Countries visited + dates"></textarea>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="validVisas">Current Valid Visas</label>
            <textarea id="validVisas" rows="2" class="w-full border rounded-md p-2"></textarea>
          </div>
        </div>

        <!-- Additional -->
        <div>
          <h2 class="text-xl font-semibold pt-2">Additional Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="specialEvents">Special Events / Highlights</label>
              <textarea id="specialEvents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="compellingReasons">Compelling Personal Reasons</label>
              <textarea id="compellingReasons" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="supportingLetters">Supporting Letters/Documents</label>
              <textarea id="supportingLetters" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="potentialWeaknesses">Potential Weaknesses to Explain</label>
              <textarea id="potentialWeaknesses" rows="2" class="w-full border rounded-md p-2" placeholder="e.g., low balance, new account, gaps in employment"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="pt-2 flex items-center gap-4">
          <button id="generateBtn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:pointer-events-none">Generate Letter</button>
          <div id="spinner" class="spinner hidden"></div>
          <p id="statusMsg" class="text-sm text-gray-600"></p>
        </div>
      </form>
    </section>

    <section id="output-section" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Letter</h2>
      <textarea id="output" class="w-full h-64 border rounded-md p-3 bg-gray-100" readonly></textarea>
      <div class="mt-3 flex flex-wrap gap-3">
        <button id="copyBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Copy to Clipboard</button>
        <button id="downloadBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Download as DOC</button>
        <button id="printBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Print Letter</button>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('visaForm');
    const spinner = document.getElementById('spinner');
    const statusMsg = document.getElementById('statusMsg');
    const generateBtn = document.getElementById('generateBtn');
    const outputSection = document.getElementById('output-section');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');

    const applicationType = document.getElementById('applicationType');
    const employmentStatus = document.getElementById('employmentStatus');

    const visaType = document.getElementById('visaType');
    const visaTypeOtherWrap = document.getElementById('visaTypeOtherWrap');
    const visaTypeOther = document.getElementById('visaTypeOther');

    const invited = document.getElementById('invited');
    const inviterWrap = document.getElementById('inviterWrap');

    const businessBlock = document.getElementById('businessBlock');
    const medicalBlock = document.getElementById('medicalBlock');
    const businessDetails = document.getElementById('businessDetails');
    const medicalDetails = document.getElementById('medicalDetails');

    const refusalBlockTop = document.getElementById('refusalBlockTop');
    const visaRefusalsTop = document.getElementById('visaRefusalsTop');

    const funding = document.getElementById('funding');
    const fundingOtherWrap = document.getElementById('fundingOtherWrap');
    const fundingOther = document.getElementById('fundingOther');

    const familyBlock = document.getElementById('familyBlock');
    const employerBlock = document.getElementById('employerBlock');
    const sponsorBlock = document.getElementById('sponsorBlock');

    const monthlyExpenses = document.getElementById('monthlyExpenses');
    const currentBankBalance = document.getElementById('currentBankBalance');
    const estimatedTripCost = document.getElementById('estimatedTripCost');
    const financeCalc = document.getElementById('financeCalc');

    // Toggles
    applicationType.addEventListener('change', () => {
      const reapp = applicationType.value === 'Reapplication';
      refusalBlockTop.classList.toggle('hidden', !reapp);
    });

    visaType.addEventListener('change', () => {
      const v = visaType.value;
      businessBlock.classList.toggle('hidden', v !== 'Business');
      medicalBlock.classList.toggle('hidden', v !== 'Medical');
      visaTypeOtherWrap.classList.toggle('hidden', v !== 'Other');
    });

    invited.addEventListener('change', () => {
      const show = invited.value === 'Yes';
      inviterWrap.classList.toggle('hidden', !show);
      if (!show) ['inviterName','inviterAddress','inviterRelationship','inviterDocs']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    });

    funding.addEventListener('change', () => {
      const f = funding.value;
      familyBlock.classList.add('hidden');
      employerBlock.classList.add('hidden');
      sponsorBlock.classList.add('hidden');
      fundingOtherWrap.classList.add('hidden');

      if (f === 'Family') familyBlock.classList.remove('hidden');
      else if (f === 'Employer') employerBlock.classList.remove('hidden');
      else if (f === 'Sponsor') sponsorBlock.classList.remove('hidden');
      else if (f === 'Other') fundingOtherWrap.classList.remove('hidden');

      // clear irrelevant fields when switching
      if (f !== 'Family') ['familyName','familyRelationship','familyOccupation','familyIncome','familyAccommodation','familyDocs']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      if (f !== 'Employer') ['employerName2','employerContact','employerCovers','employerAccommodation','employerDocs']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      if (f !== 'Sponsor') ['sponsorName','sponsorRelationship','sponsorOccupation','sponsorIncome','sponsorAccommodation','sponsorDocs']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      if (f !== 'Other') fundingOther.value = '';
    });

    // Finance helper
    ['income','monthlyExpenses','estimatedTripCost','currentBankBalance'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', showFinance);
    });
    function num(x){ if(!x) return NaN; const s=(''+x).replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return isNaN(n)?NaN:n; }
    function showFinance(){
      const income = num(document.getElementById('income').value);
      const expenses = num(monthlyExpenses.value);
      const trip = num(estimatedTripCost.value);
      const balance = num(currentBankBalance.value);

      if(isNaN(income) && isNaN(expenses) && isNaN(trip) && isNaN(balance)){
        financeCalc.classList.add('hidden'); financeCalc.textContent=''; return;
      }
      const disp = (isNaN(income)?0:income) - (isNaN(expenses)?0:expenses);
      const ratio = isNaN(trip) || disp<=0 ? null : (trip/disp);
      const remain = isNaN(balance) || isNaN(trip) ? null : (balance - trip);

      financeCalc.classList.remove('hidden');
      financeCalc.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
          <div><span class="font-semibold">Disposable Income (≈):</span> ${isNaN(disp)?'—':disp.toLocaleString()}</div>
          <div><span class="font-semibold">Trip/Disposable Ratio:</span> ${ratio===null?'—':ratio.toFixed(2)} ${ratio!==null? (ratio<=1?'(Affordable within ~1 month)':'(May need sponsor/assets)'):''}</div>
          <div><span class="font-semibold">Balance after Trip (≈):</span> ${remain===null?'—':remain.toLocaleString()}</div>
        </div>
      `;
    }

    // helpers
    function v(id){ return document.getElementById(id)?.value?.trim() || '' }

    function getFormData(){
      // purpose-specific into specialEvents
      let special = v('specialEvents');
      if(visaType.value==='Business' && v('businessDetails')){
        special += (special?'\n':'') + `Business/Conference: ${v('businessDetails')}`;
      }
      if(visaType.value==='Medical' && v('medicalDetails')){
        special += (special?'\n':'') + `Medical: ${v('medicalDetails')}`;
      }
      if(visaType.value==='Other' && v('visaTypeOther')){
        special += (special?'\n':'') + `Visa Type (Other): ${v('visaTypeOther')}`;
      }
      if(funding.value==='Other' && v('fundingOther')){
        special += (special?'\n':'') + `Funding (Other): ${v('fundingOther')}`;
      }

      // finance synthesis → bankStatementDetails
      const summaryBits = [];
      if(v('income')) summaryBits.push(`Monthly Income: ${v('income')}`);
      if(v('monthlyExpenses')) summaryBits.push(`Monthly Expenses: ${v('monthlyExpenses')}`);
      if(v('currentBankBalance')) summaryBits.push(`Current Bank Balance: ${v('currentBankBalance')}`);
      if(v('estimatedTripCost')) summaryBits.push(`Estimated Trip Cost: ${v('estimatedTripCost')}`);

      const flags = [];
      if(applicationType.value) flags.push(`Application Type: ${applicationType.value}`);
      if(employmentStatus.value) flags.push(`Employment Status: ${employmentStatus.value}`);
      flags.push(`Funding: ${funding.value || 'Self-funded'}`);
      if(flags.length) summaryBits.push(flags.join(' | '));

      const bankSynthesis = summaryBits.length
        ? `${v('bankStatementDetails') ? v('bankStatementDetails') + '\n' : ''}${summaryBits.join(' • ')}`
        : v('bankStatementDetails');

      // map funding blocks → backend sponsor fields
      let sName='', sRel='', sOcc='', sInc='', sAcc='', sDocs='';
      if(funding.value==='Family'){
        sName=v('familyName'); sRel=v('familyRelationship'); sOcc=v('familyOccupation');
        sInc=v('familyIncome'); sAcc=v('familyAccommodation'); sDocs=v('familyDocs');
      }else if(funding.value==='Employer'){
        sName=v('employerName2'); sRel=v('employerContact') || 'Employer';
        sOcc='Company'; sInc=''; sAcc=v('employerAccommodation');
        sDocs= ['Employer covers: '+(v('employerCovers')||'not stated'), v('employerDocs')].filter(Boolean).join(' | ');
      }else if(funding.value==='Sponsor'){
        sName=v('sponsorName'); sRel=v('sponsorRelationship'); sOcc=v('sponsorOccupation');
        sInc=v('sponsorIncome'); sAcc=v('sponsorAccommodation'); sDocs=v('sponsorDocs');
      }

      const isSelfFunded = !funding.value || funding.value === '' ;

      return {
        // Personal
        name: v('name'),
        age: v('age'),
        nationality: v('nationality'),
        applicantAddress: v('applicantAddress'),
        contactPhone: v('contactPhone'),
        contactEmail: v('contactEmail'),
        dateOfBirth: v('dateOfBirth'),
        passportNumber: v('passportNumber'),
        passportIssueDate: v('passportIssueDate'),
        passportExpiryDate: v('passportExpiryDate'),
        maritalStatus: v('maritalStatus'),
        numDependents: v('numDependents'),

        // Travel
        destination: v('destination'),
        visaType: v('visaType'),
        purpose: v('purpose'),
        travelDates: v('travelDates'),
        entryDate: v('entryDate'),
        stayDuration: v('stayDuration'),
        invited: v('invited'),
        inviterName: v('inviterName'),
        inviterAddress: v('inviterAddress'),
        inviterRelationship: v('inviterRelationship'),
        inviterDocs: v('inviterDocs'),
        stayDetails: v('stayDetails'),
        travelItinerary: v('travelItinerary'),

        // Employment & Finances
        occupation: v('occupation'),
        employerName: v('employerName'),
        employerAddress: v('employerAddress'),
        employmentDuration: v('employmentDuration'),
        income: v('income'),
        otherIncome: v('otherIncome'),
        funding: funding.value, // single source of truth
        bankStatementDetails: bankSynthesis,
        significantTransactions: v('significantTransactions'),

        // Consular
        accommodation: v('stayDetails') || v('accommodation'),
        documents: v('documents'),
        embassyName: v('embassyName'),
        embassyAddress: v('embassyAddress'),
        companyName: v('companyName') || 'No Guide Travel Agent',

        // Ties
        propertyDetails: v('propertyDetails'),
        businessCommitments: v('businessCommitments'),
        familyDependents: v('familyDependents'),
        otherCommitments: v('otherCommitments'),

        // History
        travelHistory: v('travelHistory'),
        visaRefusals: (applicationType.value==='Reapplication'
          ? (visaRefusalsTop.value.trim() || 'Refusal stated but details not provided')
          : '' ),
        validVisas: v('validVisas'),

        // Sponsor mapping
        sponsorSelf: isSelfFunded ? 'Yes' : 'No',
        sponsorName: sName,
        sponsorRelationship: sRel,
        sponsorOccupation: sOcc,
        sponsorIncome: sInc,
        sponsorAccommodation: sAcc,
        sponsorDocs: sDocs,

        // Additional
        specialEvents: special,
        compellingReasons: v('compellingReasons'),
        supportingLetters: v('supportingLetters'),
        potentialWeaknesses: v('potentialWeaknesses')
      };
    }

    function validateForm(data){
      const missing = [];
      if(!data.name) missing.push('Name');
      if(!data.age) missing.push('Age');
      if(!data.nationality) missing.push('Nationality');
      if(!data.destination) missing.push('Destination Country');
      if(!data.visaType) missing.push('Visa Type');
      if(!data.purpose) missing.push('Purpose of Travel');
      if(!data.income) missing.push('Monthly Income');
      if(!applicationType.value) missing.push('Application Type');
      if(!employmentStatus.value) missing.push('Employment Status');

      if(applicationType.value==='Reapplication' && !visaRefusalsTop.value.trim()){
        missing.push('Refusal Reasons');
      }
      if(visaType.value==='Business' && !v('businessDetails')) missing.push('Business/Conference Details');
      if(visaType.value==='Medical' && !v('medicalDetails')) missing.push('Medical Details');
      if(visaType.value==='Other' && !visaTypeOther.value.trim()) missing.push('Visa Type (Other) — specify');

      // Funding-specific requirements
      if(funding.value==='Other' && !fundingOther.value.trim()){
        missing.push('Funding (Other) — specify');
      }
      if(funding.value==='Family'){
        if(!v('familyName')) missing.push('Family Sponsor Name');
        if(!v('familyRelationship')) missing.push('Family Relationship');
      }
      if(funding.value==='Employer'){
        if(!v('employerName2')) missing.push('Company Name (Employer)');
        if(!v('employerContact')) missing.push('Company Contact/HR');
      }
      if(funding.value==='Sponsor'){
        if(!v('sponsorName')) missing.push('Sponsor Name');
        if(!v('sponsorRelationship')) missing.push('Sponsor Relationship');
      }

      // invited = No → clear inviter fields
      if(invited.value === 'No'){
        ['inviterName','inviterAddress','inviterRelationship','inviterDocs']
          .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      }
      return missing;
    }

    async function generateLetter(payload){
      const response = await fetch('https://visa-cover-letter-api.onrender.com/generate-letter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!response.ok){
        const errorData = await response.json().catch(()=>null);
        throw new Error(errorData?.error || 'Unexpected server error');
      }
      const data = await response.json();
      return data.letter;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = getFormData();
      const missing = validateForm(payload);
      if(missing.length){
        statusMsg.textContent = `Missing required fields: ${missing.join(', ')}`;
        statusMsg.classList.add('text-red-600');
        return;
      }
      statusMsg.textContent = '';
      spinner.classList.remove('hidden');
      generateBtn.disabled = true;
      try{
        const letter = await generateLetter(payload);
        output.value = letter;
        outputSection.classList.remove('hidden');
        statusMsg.textContent = 'Letter generated successfully';
        statusMsg.classList.remove('text-red-600');
        statusMsg.classList.add('text-green-600');
      }catch(err){
        console.error(err);
        statusMsg.textContent = err.message || 'Failed to generate letter';
        statusMsg.classList.add('text-red-600');
      }finally{
        spinner.classList.add('hidden');
        generateBtn.disabled = false;
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.value); alert('Letter copied to clipboard'); }
      catch{ alert('Could not copy'); }
    });

    downloadBtn.addEventListener('click', ()=>{
      const blob = new Blob([output.value], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'visa_cover_letter.doc';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    printBtn.addEventListener('click', ()=>{
      const win = window.open('', '_blank'); if(!win) return;
      win.document.write(`<!doctype html><html><head><title>Visa Cover Letter</title></head><body style="white-space: pre-wrap; font-family: serif; margin: 40px;">${
        output.value.replace(/</g,'&lt;').replace(/>/g,'&gt;')
      }</body></html>`); win.document.close(); win.focus(); win.print();
    });
  </script>
</body>
</html>
