<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Guide Visa Cover Letter Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner{border:4px solid rgba(0,0,0,0.1);width:36px;height:36px;border-radius:50%;border-left-color:#000;animation:spin 1s ease infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .hint{font-size:.8rem}
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-1">Visa Application Cover Letter Generator</h1>
      <p class="text-sm text-gray-600">Powered by No Guide Travel Agent</p>
    </header>

    <section id="form-container" class="bg-white shadow-md rounded-xl p-6 space-y-6">
      <form id="visaForm" class="space-y-6">
        <!-- Decision flags (SOP) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1" for="applicationType">Application Type <span class="text-red-500">*</span></label>
            <select id="applicationType" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="First-time">First-time</option>
              <option value="Reapplication">Reapplication (after refusal)</option>
            </select>
            <p class="hint text-gray-500 mt-1">If reapplying, you’ll explain refusal reasons.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="employmentStatus">Employment Status <span class="text-red-500">*</span></label>
            <select id="employmentStatus" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="Employed">Employed</option>
              <option value="Self-employed">Self-employed</option>
              <option value="Unemployed">Unemployed</option>
              <option value="Student">Student</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="isSponsored">Sponsored? <span class="text-red-500">*</span></label>
            <select id="isSponsored" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="No">No (self-funded)</option>
              <option value="Yes">Yes (family/company)</option>
            </select>
          </div>
        </div>

        <!-- Applicant Information -->
        <div>
          <h2 class="text-xl font-semibold">Applicant Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="name">Full Name <span class="text-red-500">*</span></label>
              <input id="name" type="text" class="w-full border rounded-md p-2" required />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="age">Age <span class="text-red-500">*</span></label>
                <input id="age" type="number" min="0" class="w-full border rounded-md p-2" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="nationality">Nationality <span class="text-red-500">*</span></label>
                <input id="nationality" type="text" class="w-full border rounded-md p-2" required />
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="applicantAddress">Address</label>
              <input id="applicantAddress" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactPhone">Phone</label>
              <input id="contactPhone" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactEmail">Email</label>
              <input id="contactEmail" type="email" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="dateOfBirth">Date of Birth</label>
              <input id="dateOfBirth" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportNumber">Passport Number</label>
              <input id="passportNumber" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportIssueDate">Passport Issue Date</label>
              <input id="passportIssueDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportExpiryDate">Passport Expiry Date</label>
              <input id="passportExpiryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="maritalStatus">Marital Status</label>
              <select id="maritalStatus" class="w-full border rounded-md p-2">
                <option value="">Select</option>
                <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option><option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="numDependents">Number of Dependents</label>
              <input id="numDependents" type="number" min="0" class="w-full border rounded-md p-2" />
            </div>
          </div>
        </div>

        <!-- Travel & Visa Details -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="destination">Destination Country <span class="text-red-500">*</span></label>
              <input id="destination" type="text" class="w-full border rounded-md p-2" placeholder="United Kingdom" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="visaType">Visa Type <span class="text-red-500">*</span></label>
              <select id="visaType" class="w-full border rounded-md p-2" required>
                <option value="">Select</option>
                <option>Tourist</option><option>Business</option><option>Study</option>
                <option>Medical</option><option>Visit</option><option>Other</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="purpose">Purpose of Travel <span class="text-red-500">*</span></label>
              <textarea id="purpose" rows="2" class="w-full border rounded-md p-2" required placeholder="Tourism, visiting family, conference, medical treatment, etc."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="travelDates">Travel Dates</label>
              <input id="travelDates" type="text" class="w-full border rounded-md p-2" placeholder="10 Oct – 20 Oct 2025" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="entryDate">Planned Date of Entry</label>
              <input id="entryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDuration">Duration of Stay</label>
              <input id="stayDuration" type="text" class="w-full border rounded-md p-2" placeholder="10 days" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="invited">Invited by someone in the UK?</label>
              <select id="invited" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDetails">Accommodation / Host Details</label>
              <textarea id="stayDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hotel info or host address"></textarea>
            </div>
            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterName">Inviter's Name</label>
                <input id="inviterName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterAddress">Inviter's Address</label>
                <input id="inviterAddress" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterRelationship">Inviter's Relationship</label>
                <input id="inviterRelationship" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterDocs">Inviter's Supporting Documents</label>
                <input id="inviterDocs" type="text" class="w-full border rounded-md p-2" placeholder="Invitation letter, passport, BRP" />
              </div>
            </div>
          </div>

          <!-- Purpose-specific details -->
          <div id="businessBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Business/Conference Details</label>
            <textarea id="businessDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Conference name, dates, invitation, who pays"></textarea>
          </div>
          <div id="medicalBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Medical Details</label>
            <textarea id="medicalDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hospital name, appointment window, who covers costs"></textarea>
          </div>
        </div>

        <!-- Employment & Finances -->
        <div>
          <h2 class="text-xl font-semibold">Employment & Finances</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="occupation">Occupation / Employer</label>
              <input id="occupation" type="text" class="w-full border rounded-md p-2" placeholder="Software Developer at XYZ Ltd." />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="income">Monthly Income <span class="text-red-500">*</span></label>
              <input id="income" type="text" class="w-full border rounded-md p-2" placeholder="₦750,000" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="monthlyExpenses">Monthly Expenses (avg)</label>
              <input id="monthlyExpenses" type="text" class="w-full border rounded-md p-2" placeholder="₦300,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="currentBankBalance">Current Bank Balance</label>
              <input id="currentBankBalance" type="text" class="w-full border rounded-md p-2" placeholder="₦5,600,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="estimatedTripCost">Estimated Trip Cost (GBP or ₦)</label>
              <input id="estimatedTripCost" type="text" class="w-full border rounded-md p-2" placeholder="£2,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="funding">Funding Source</label>
              <select id="funding" class="w-full border rounded-md p-2">
                <option value="">Self-funded</option>
                <option>Employer</option><option>Family</option><option>Sponsor</option><option>Other</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="bankStatementDetails">Bank Statement Details</label>
              <textarea id="bankStatementDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Bank name, balance trend"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="significantTransactions">Significant Transactions / Lump Sums</label>
              <textarea id="significantTransactions" rows="2" class="w-full border rounded-md p-2" placeholder="Explain large/irregular transactions"></textarea>
            </div>
          </div>
          <div id="financeCalc" class="mt-2 text-sm text-gray-700 hidden"></div>
        </div>

        <!-- Consular details -->
        <div>
          <h2 class="text-xl font-semibold">Consular Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyName">Embassy Name</label>
              <input id="embassyName" type="text" class="w-full border rounded-md p-2" placeholder="The British Deputy High Commissioner" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyAddress">Embassy Address</label>
              <input id="embassyAddress" type="text" class="w-full border rounded-md p-2" placeholder="11 Walter Carrington Crescent, VI, Lagos" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="companyName">Company Name (branding)</label>
              <input id="companyName" type="text" class="w-full border rounded-md p-2" value="No Guide Travel Agent" />
            </div>
          </div>
        </div>

        <!-- Ties & commitments -->
        <div>
          <h2 class="text-xl font-semibold">Ties to Nigeria & Commitments</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="propertyDetails">Property Ownership</label>
              <textarea id="propertyDetails" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="businessCommitments">Business / Employment Commitments</label>
              <textarea id="businessCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="familyDependents">Family / Dependents</label>
              <textarea id="familyDependents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="otherCommitments">Other Commitments</label>
              <textarea id="otherCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
          </div>
        </div>

        <!-- Travel & visa history -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa History</h2>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="travelHistory">Past Travel History</label>
            <textarea id="travelHistory" rows="2" class="w-full border rounded-md p-2" placeholder="Countries visited + dates"></textarea>
          </div>
          <div id="refusalBlock" class="mt-3 hidden">
            <label class="block text-sm font-medium mb-1" for="visaRefusals">Previous Visa Refusals (reasons & date)</label>
            <textarea id="visaRefusals" rows="2" class="w-full border rounded-md p-2" placeholder="List refusal reasons; attach refs in docs"></textarea>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="validVisas">Current Valid Visas</label>
            <textarea id="validVisas" rows="2" class="w-full border rounded-md p-2"></textarea>
          </div>
        </div>

        <!-- Sponsor -->
        <div id="sponsorBlock" class="hidden">
          <h2 class="text-xl font-semibold pt-4">Sponsor Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorName">Sponsor's Name</label>
              <input id="sponsorName" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorRelationship">Sponsor's Relationship</label>
              <input id="sponsorRelationship" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorOccupation">Sponsor's Occupation</label>
              <input id="sponsorOccupation" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorIncome">Sponsor's Income</label>
              <input id="sponsorIncome" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorAccommodation">Will Sponsor Provide Accommodation?</label>
              <select id="sponsorAccommodation" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="sponsorDocs">Sponsor's Documents</label>
              <textarea id="sponsorDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Bank statements, payslips, invitation letter"></textarea>
            </div>
          </div>
        </div>

        <!-- Additional -->
        <div>
          <h2 class="text-xl font-semibold pt-2">Additional Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="specialEvents">Special Events / Highlights</label>
              <textarea id="specialEvents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="compellingReasons">Compelling Personal Reasons</label>
              <textarea id="compellingReasons" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="supportingLetters">Supporting Letters/Documents</label>
              <textarea id="supportingLetters" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="potentialWeaknesses">Potential Weaknesses to Explain</label>
              <textarea id="potentialWeaknesses" rows="2" class="w-full border rounded-md p-2" placeholder="e.g., low balance, new account, gaps in employment"></textarea>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="pt-2 flex items-center gap-4">
          <button id="generateBtn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:pointer-events-none">Generate Letter</button>
          <div id="spinner" class="spinner hidden"></div>
          <p id="statusMsg" class="text-sm text-gray-600"></p>
        </div>
      </form>
    </section>

    <section id="output-section" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Letter</h2>
      <textarea id="output" class="w-full h-64 border rounded-md p-3 bg-gray-100" readonly></textarea>
      <div class="mt-3 flex flex-wrap gap-3">
        <button id="copyBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Copy to Clipboard</button>
        <button id="downloadBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Download as DOC</button>
        <button id="printBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Print Letter</button>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('visaForm');
    const spinner = document.getElementById('spinner');
    const statusMsg = document.getElementById('statusMsg');
    const generateBtn = document.getElementById('generateBtn');
    const outputSection = document.getElementById('output-section');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');

    const applicationType = document.getElementById('applicationType');
    const employmentStatus = document.getElementById('employmentStatus');
    const isSponsored = document.getElementById('isSponsored');
    const visaType = document.getElementById('visaType');

    const sponsorBlock = document.getElementById('sponsorBlock');
    const refusalBlock = document.getElementById('refusalBlock');
    const businessBlock = document.getElementById('businessBlock');
    const medicalBlock = document.getElementById('medicalBlock');

    const visaRefusals = document.getElementById('visaRefusals');
    const businessDetails = document.getElementById('businessDetails');
    const medicalDetails = document.getElementById('medicalDetails');

    const monthlyExpenses = document.getElementById('monthlyExpenses');
    const currentBankBalance = document.getElementById('currentBankBalance');
    const estimatedTripCost = document.getElementById('estimatedTripCost');
    const financeCalc = document.getElementById('financeCalc');

    // Conditional UI
    applicationType.addEventListener('change', () => {
      refusalBlock.classList.toggle('hidden', applicationType.value !== 'Reapplication');
    });

    isSponsored.addEventListener('change', () => {
      sponsorBlock.classList.toggle('hidden', isSponsored.value !== 'Yes');
    });

    visaType.addEventListener('change', () => {
      const v = visaType.value;
      businessBlock.classList.toggle('hidden', v !== 'Business');
      medicalBlock.classList.toggle('hidden', v !== 'Medical');
    });

    // Helper: parse number safely from ₦/£ strings
    function num(x){
      if(!x) return NaN;
      const s = (''+x).replace(/[^0-9.\-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? NaN : n;
    }

    // Live finance calculation (for SOP affordability)
    [monthlyExpenses, estimatedTripCost, currentBankBalance].forEach(el=>{
      el.addEventListener('input', showFinance);
    });
    function showFinance(){
      const income = num(document.getElementById('income').value);
      const expenses = num(monthlyExpenses.value);
      const trip = num(estimatedTripCost.value);
      const balance = num(currentBankBalance.value);

      if(isNaN(income) && isNaN(expenses) && isNaN(trip) && isNaN(balance)){
        financeCalc.classList.add('hidden'); financeCalc.textContent=''; return;
      }
      const disp = (isNaN(income)?0:income) - (isNaN(expenses)?0:expenses);
      const ratio = isNaN(trip) || disp<=0 ? null : (trip/disp);
      const remain = isNaN(balance) || isNaN(trip) ? null : (balance - trip);

      financeCalc.classList.remove('hidden');
      financeCalc.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
          <div><span class="font-semibold">Disposable Income (≈):</span> ${isNaN(disp)?'—':disp.toLocaleString()}</div>
          <div><span class="font-semibold">Trip/Disposable Ratio:</span> ${ratio===null?'—':ratio.toFixed(2)} ${ratio!==null? (ratio<=1?'(Affordable within ~1 month)':'(May need sponsor/assets)'):''}</div>
          <div><span class="font-semibold">Balance after Trip (≈):</span> ${remain===null?'—':remain.toLocaleString()}</div>
        </div>
      `;
    }

    // Collect form values
    function v(id){ return document.getElementById(id)?.value?.trim() || '' }
    function getFormData(){
      // Purpose-specific → fold into specialEvents for backend
      let special = v('specialEvents');
      if(visaType.value==='Business' && businessDetails.value){
        special += (special?'\n':'') + `Business/Conference: ${businessDetails.value}`;
      }
      if(visaType.value==='Medical' && medicalDetails.value){
        special += (special?'\n':'') + `Medical: ${medicalDetails.value}`;
      }

      // Finance synthesis appended to bankStatementDetails (so server uses it)
      const income = v('income');
      const exp = v('monthlyExpenses');
      const bal = v('currentBankBalance');
      const trip = v('estimatedTripCost');
      const summaryBits = [];
      if(income) summaryBits.push(`Monthly Income: ${income}`);
      if(exp) summaryBits.push(`Monthly Expenses: ${exp}`);
      if(bal) summaryBits.push(`Current Bank Balance: ${bal}`);
      if(trip) summaryBits.push(`Estimated Trip Cost: ${trip}`);

      // Also reflect SOP flags into fields server already understands
      // - Reapplication reasons -> visaRefusals
      // - Sponsored? -> sponsorSelf = Yes/No
      const flags = [];
      if(applicationType.value) flags.push(`Application Type: ${applicationType.value}`);
      if(employmentStatus.value) flags.push(`Employment Status: ${employmentStatus.value}`);
      if(isSponsored.value) flags.push(`Sponsored: ${isSponsored.value}`);
      if(flags.length) summaryBits.push(flags.join(' | '));

      const bankDetailsExisting = v('bankStatementDetails');
      const bankSynthesis = summaryBits.length ? `${bankDetailsExisting ? bankDetailsExisting + '\n' : ''}${summaryBits.join(' • ')}` : bankDetailsExisting;

      return {
        // Personal
        name: v('name'),
        age: v('age'),
        nationality: v('nationality'),
        applicantAddress: v('applicantAddress'),
        contactPhone: v('contactPhone'),
        contactEmail: v('contactEmail'),
        dateOfBirth: v('dateOfBirth'),
        passportNumber: v('passportNumber'),
        passportIssueDate: v('passportIssueDate'),
        passportExpiryDate: v('passportExpiryDate'),
        maritalStatus: v('maritalStatus'),
        numDependents: v('numDependents'),

        // Travel
        destination: v('destination'),
        visaType: v('visaType'),
        purpose: v('purpose'),
        travelDates: v('travelDates'),
        entryDate: v('entryDate'),
        stayDuration: v('stayDuration'),
        invited: v('invited'),
        inviterName: v('inviterName'),
        inviterAddress: v('inviterAddress'),
        inviterRelationship: v('inviterRelationship'),
        inviterDocs: v('inviterDocs'),
        stayDetails: v('stayDetails'),
        travelItinerary: v('travelItinerary'),

        // Employment & Finances
        occupation: v('occupation'),
        employerName: v('employerName'),
        employerAddress: v('employerAddress'),
        employmentDuration: v('employmentDuration'),
        income,
        otherIncome: v('otherIncome'),
        funding: v('funding'),
        bankStatementDetails: bankSynthesis,
        significantTransactions: v('significantTransactions'),

        // Logistics / Consular
        accommodation: v('stayDetails') || v('accommodation'), // prefer stayDetails
        documents: v('documents'),
        embassyName: v('embassyName'),
        embassyAddress: v('embassyAddress'),
        companyName: v('companyName') || 'No Guide Travel Agent',

        // Ties
        propertyDetails: v('propertyDetails'),
        businessCommitments: v('businessCommitments'),
        familyDependents: v('familyDependents'),
        otherCommitments: v('otherCommitments'),

        // History
        travelHistory: v('travelHistory'),
        visaRefusals: (applicationType.value==='Reapplication' ? (v('visaRefusals') || 'Refusal stated but details not provided') : v('visaRefusals')),
        validVisas: v('validVisas'),

        // Sponsor
        sponsorSelf: (isSponsored.value==='Yes' ? 'No' : 'Yes'),
        sponsorName: v('sponsorName'),
        sponsorRelationship: v('sponsorRelationship'),
        sponsorOccupation: v('sponsorOccupation'),
        sponsorIncome: v('sponsorIncome'),
        sponsorAccommodation: v('sponsorAccommodation'),
        sponsorDocs: v('sponsorDocs'),

        // Additional
        specialEvents: special,
        compellingReasons: v('compellingReasons'),
        supportingLetters: v('supportingLetters'),
        potentialWeaknesses: v('potentialWeaknesses')
      };
    }

    function validateForm(data){
      const missing = [];
      if(!data.name) missing.push('Name');
      if(!data.age) missing.push('Age');
      if(!data.nationality) missing.push('Nationality');
      if(!data.destination) missing.push('Destination Country');
      if(!data.visaType) missing.push('Visa Type');
      if(!data.purpose) missing.push('Purpose of Travel');
      if(!data.income) missing.push('Monthly Income');
      if(!applicationType.value) missing.push('Application Type');
      if(!employmentStatus.value) missing.push('Employment Status');
      if(!isSponsored.value) missing.push('Sponsored?');

      // Conditional requirements
      if(applicationType.value==='Reapplication' && !v('visaRefusals')){
        missing.push('Refusal Reasons');
      }
      if(isSponsored.value==='Yes'){
        if(!v('sponsorName')) missing.push('Sponsor Name');
        if(!v('sponsorRelationship')) missing.push('Sponsor Relationship');
      }
      if(visaType.value==='Business' && !v('businessDetails')){
        missing.push('Business/Conference Details');
      }
      if(visaType.value==='Medical' && !v('medicalDetails')){
        missing.push('Medical Details');
      }
      return missing;
    }

    async function generateLetter(payload){
      const response = await fetch('https://visa-cover-letter-api.onrender.com/generate-letter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!response.ok){
        const errorData = await response.json().catch(()=>null);
        throw new Error(errorData?.error || 'Unexpected server error');
      }
      const data = await response.json();
      return data.letter;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = getFormData();
      const missing = validateForm(payload);
      if(missing.length){
        statusMsg.textContent = `Missing required fields: ${missing.join(', ')}`;
        statusMsg.classList.add('text-red-600');
        return;
      }
      statusMsg.textContent = '';
      spinner.classList.remove('hidden');
      generateBtn.disabled = true;
      try{
        const letter = await generateLetter(payload);
        output.value = letter;
        outputSection.classList.remove('hidden');
        statusMsg.textContent = 'Letter generated successfully';
        statusMsg.classList.remove('text-red-600');
        statusMsg.classList.add('text-green-600');
      }catch(err){
        console.error(err);
        statusMsg.textContent = err.message || 'Failed to generate letter';
        statusMsg.classList.add('text-red-600');
      }finally{
        spinner.classList.add('hidden');
        generateBtn.disabled = false;
      }
    });

    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.value); alert('Letter copied to clipboard'); }
      catch{ alert('Could not copy'); }
    });

    downloadBtn.addEventListener('click', ()=>{
      const blob = new Blob([output.value], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'visa_cover_letter.doc';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    });

    printBtn.addEventListener('click', ()=>{
      const win = window.open('', '_blank'); if(!win) return;
      win.document.write(`<!doctype html><html><head><title>Visa Cover Letter</title></head><body style="white-space: pre-wrap; font-family: serif; margin: 40px;">${
        output.value.replace(/</g,'&lt;').replace(/>/g,'&gt;')
      }</body></html>`); win.document.close(); win.focus(); win.print();
    });
  </script>
</body>
</html>
