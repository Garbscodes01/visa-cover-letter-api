<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Guide Visa Cover Letter Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner{border:4px solid rgba(0,0,0,0.1);width:36px;height:36px;border-radius:50%;border-left-color:#000;animation:spin 1s ease infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .hint{font-size:.8rem}
    .hidden{display:none}
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-1">Visa Application Cover Letter Generator</h1>
      <p class="text-sm text-gray-600">Powered by No Guide Travel Agent</p>
    </header>

    <section id="form-container" class="bg-white shadow-md rounded-xl p-6 space-y-6">
      <form id="visaForm" class="space-y-6">
        <!-- High-level flags -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1" for="applicationType">Application Type <span class="text-red-500">*</span></label>
            <select id="applicationType" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option value="First-time">First-time</option>
              <option value="Reapplication">Reapplication (after refusal)</option>
            </select>
            <p class="hint text-gray-500 mt-1">If reapplying, refusal reasons will be required.</p>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="employmentStatus">Employment Status <span class="text-red-500">*</span></label>
            <select id="employmentStatus" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option>Employed</option>
              <option>Self-employed</option>
              <option>Unemployed</option>
              <option>Student</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" for="isSponsored">Sponsored? <span class="text-red-500">*</span></label>
            <select id="isSponsored" class="w-full border rounded-md p-2" required>
              <option value="">Select</option>
              <option>No">No (self-funded)</option>
              <option>Yes">Yes (family/company)</option>
            </select>
          </div>
        </div>

        <!-- Applicant -->
        <div>
          <h2 class="text-xl font-semibold">Applicant Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="name">Full Name <span class="text-red-500">*</span></label>
              <input id="name" type="text" class="w-full border rounded-md p-2" required />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="age">Age <span class="text-red-500">*</span></label>
                <input id="age" type="number" min="0" class="w-full border rounded-md p-2" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="nationality">Nationality <span class="text-red-500">*</span></label>
                <input id="nationality" type="text" class="w-full border rounded-md p-2" required />
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="applicantAddress">Address</label>
              <input id="applicantAddress" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactPhone">Phone</label>
              <input id="contactPhone" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="contactEmail">Email</label>
              <input id="contactEmail" type="email" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="dateOfBirth">Date of Birth</label>
              <input id="dateOfBirth" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportNumber">Passport Number</label>
              <input id="passportNumber" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportIssueDate">Passport Issue Date</label>
              <input id="passportIssueDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="passportExpiryDate">Passport Expiry Date</label>
              <input id="passportExpiryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="maritalStatus">Marital Status</label>
              <select id="maritalStatus" class="w-full border rounded-md p-2">
                <option value="">Select</option>
                <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option><option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="numDependents">Number of Dependents</label>
              <input id="numDependents" type="number" min="0" class="w-full border rounded-md p-2" />
            </div>
          </div>
        </div>

        <!-- Travel & Visa -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="destination">Destination Country <span class="text-red-500">*</span></label>
              <input id="destination" type="text" class="w-full border rounded-md p-2" placeholder="United Kingdom" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="visaType">Visa Type <span class="text-red-500">*</span></label>
              <select id="visaType" class="w-full border rounded-md p-2" required>
                <option value="">Select</option>
                <option>Tourist</option>
                <option>Business</option>
                <option>Study</option>
                <option>Medical</option>
                <option>Visit</option>
                <option>Other</option>
              </select>
              <input id="visaTypeOther" type="text" class="w-full border rounded-md p-2 mt-2 hidden" placeholder="Explain other visa type…" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="purpose">Purpose of Travel <span class="text-red-500">*</span></label>
              <textarea id="purpose" rows="2" class="w-full border rounded-md p-2" required placeholder="Tourism, visiting family, conference, medical treatment, etc."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="travelDates">Travel Dates</label>
              <input id="travelDates" type="text" class="w-full border rounded-md p-2" placeholder="10 Sep – 10 Dec 2025" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="entryDate">Planned Date of Entry</label>
              <input id="entryDate" type="date" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDuration">Duration of Stay</label>
              <input id="stayDuration" type="text" class="w-full border rounded-md p-2" placeholder="e.g., 90 days" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="invited">Invited by someone?</label>
              <select id="invited" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="stayDetails">Accommodation / Host Details</label>
              <textarea id="stayDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hotel info or host address"></textarea>
            </div>

            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterName">Inviter's Name</label>
                <input id="inviterName" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterAddress">Inviter's Address</label>
                <input id="inviterAddress" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterRelationship">Inviter's Relationship</label>
                <input id="inviterRelationship" type="text" class="w-full border rounded-md p-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="inviterDocs">Inviter's Supporting Documents</label>
                <input id="inviterDocs" type="text" class="w-full border rounded-md p-2" placeholder="Invitation letter, passport, BRP" />
              </div>
            </div>
          </div>

          <!-- Purpose-specific -->
          <div id="businessBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Business/Conference Details <span class="text-red-500">*</span></label>
            <textarea id="businessDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Conference name, dates, invitation, who pays"></textarea>
          </div>
          <div id="medicalBlock" class="hidden mt-3">
            <label class="block text-sm font-medium mb-1">Medical Details <span class="text-red-500">*</span></label>
            <textarea id="medicalDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Hospital name, appointment window, who covers costs"></textarea>
          </div>
        </div>

        <!-- Employment & Finances -->
        <div>
          <h2 class="text-xl font-semibold">Employment & Finances</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="occupation">Occupation / Employer</label>
              <input id="occupation" type="text" class="w-full border rounded-md p-2" placeholder="Software Developer at XYZ Ltd." />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="income">Monthly Income <span class="text-red-500">*</span></label>
              <input id="income" type="text" class="w-full border rounded-md p-2" placeholder="₦750,000" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="monthlyExpenses">Monthly Expenses (avg)</label>
              <input id="monthlyExpenses" type="text" class="w-full border rounded-md p-2" placeholder="₦300,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="currentBankBalance">Current Bank Balance</label>
              <input id="currentBankBalance" type="text" class="w-full border rounded-md p-2" placeholder="₦5,600,000" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="estimatedTripCost">Estimated Trip Cost</label>
              <input id="estimatedTripCost" type="text" class="w-full border rounded-md p-2" placeholder="£2,000 or ₦ amount" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="funding">Funding Source</label>
              <select id="funding" class="w-full border rounded-md p-2">
                <option value="">Self-funded</option>
                <option>Employer</option>
                <option>Family</option>
                <option>Sponsor</option>
                <option>Other</option>
              </select>
              <input id="fundingOther" type="text" class="w-full border rounded-md p-2 mt-2 hidden" placeholder="Explain other funding source…" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="bankStatementDetails">Bank Statement Details</label>
              <textarea id="bankStatementDetails" rows="2" class="w-full border rounded-md p-2" placeholder="Bank name, balance trend"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="significantTransactions">Significant Transactions / Lump Sums</label>
              <textarea id="significantTransactions" rows="2" class="w-full border rounded-md p-2" placeholder="Explain large/irregular transactions"></textarea>
            </div>
          </div>
          <div id="financeCalc" class="mt-2 text-sm text-gray-700 hidden"></div>
        </div>

        <!-- Consular -->
        <div>
          <h2 class="text-xl font-semibold">Consular Details</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyName">Embassy Name</label>
              <input id="embassyName" type="text" class="w-full border rounded-md p-2" placeholder="The British Deputy High Commissioner" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="embassyAddress">Embassy Address</label>
              <input id="embassyAddress" type="text" class="w-full border rounded-md p-2" placeholder="11 Walter Carrington Crescent, VI, Lagos" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="companyName">Company Name (branding)</label>
              <input id="companyName" type="text" class="w-full border rounded-md p-2" value="No Guide Travel Agent" />
            </div>
          </div>
        </div>

        <!-- Ties -->
        <div>
          <h2 class="text-xl font-semibold">Ties to Nigeria & Commitments</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="propertyDetails">Property Ownership</label>
              <textarea id="propertyDetails" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="businessCommitments">Business / Employment Commitments</label>
              <textarea id="businessCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="familyDependents">Family / Dependents</label>
              <textarea id="familyDependents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="otherCommitments">Other Commitments</label>
              <textarea id="otherCommitments" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
          </div>
        </div>

        <!-- History -->
        <div>
          <h2 class="text-xl font-semibold">Travel & Visa History</h2>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="travelHistory">Past Travel History</label>
            <textarea id="travelHistory" rows="2" class="w-full border rounded-md p-2" placeholder="Countries visited + dates"></textarea>
          </div>
          <div id="refusalBlock" class="mt-3 hidden">
            <label class="block text-sm font-medium mb-1" for="visaRefusals">Previous Visa Refusals (reasons & date)</label>
            <textarea id="visaRefusals" rows="2" class="w-full border rounded-md p-2" placeholder="List refusal reasons; attach refs in docs"></textarea>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1" for="validVisas">Current Valid Visas</label>
            <textarea id="validVisas" rows="2" class="w-full border rounded-md p-2"></textarea>
          </div>
        </div>

        <!-- Sponsor -->
        <div id="sponsorBlock" class="hidden">
          <h2 class="text-xl font-semibold pt-4">Sponsor Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorName">Sponsor's Name <span class="text-red-500 sponsor-req hidden">*</span></label>
              <input id="sponsorName" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorRelationship">Sponsor's Relationship <span class="text-red-500 sponsor-req hidden">*</span></label>
              <input id="sponsorRelationship" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorOccupation">Sponsor's Occupation</label>
              <input id="sponsorOccupation" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorIncome">Sponsor's Income</label>
              <input id="sponsorIncome" type="text" class="w-full border rounded-md p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="sponsorAccommodation">Will Sponsor Provide Accommodation?</label>
              <select id="sponsorAccommodation" class="w-full border rounded-md p-2">
                <option value="">Select</option><option>Yes</option><option>No</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="sponsorDocs">Sponsor's Documents</label>
              <textarea id="sponsorDocs" rows="2" class="w-full border rounded-md p-2" placeholder="Bank statements, payslips, invitation letter"></textarea>
            </div>
          </div>
        </div>

        <!-- Additional -->
        <div>
          <h2 class="text-xl font-semibold pt-2">Additional Information</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="specialEvents">Special Events / Highlights</label>
              <textarea id="specialEvents" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="compellingReasons">Compelling Personal Reasons</label>
              <textarea id="compellingReasons" rows="2" class="w-full border rounded-md p-2" placeholder="Brief human context that shows sincerity (e.g., family milestone, academic opportunity)."></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="supportingLetters">Supporting Letters/Documents</label>
              <textarea id="supportingLetters" rows="2" class="w-full border rounded-md p-2"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" for="potentialWeaknesses">Potential Weaknesses to Explain</label>
              <textarea id="potentialWeaknesses" rows="2" class="w-full border rounded-md p-2" placeholder="e.g., low balance, new account, short employment history."></textarea>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="pt-2 flex items-center gap-4">
          <button id="generateBtn" type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-50 disabled:pointer-events-none">Generate Letter</button>
          <div id="spinner" class="spinner hidden"></div>
          <p id="statusMsg" class="text-sm text-gray-600"></p>
        </div>
      </form>
    </section>

    <section id="output-section" class="mt-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Generated Letter</h2>
      <textarea id="output" class="w-full h-64 border rounded-md p-3 bg-gray-100" readonly></textarea>
      <div class="mt-3 flex flex-wrap gap-3">
        <button id="copyBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Copy to Clipboard</button>
        <button id="downloadBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Download as DOC</button>
        <button id="printBtn" class="px-3 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Print Letter</button>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('visaForm');
    const spinner = document.getElementById('spinner');
    const statusMsg = document.getElementById('statusMsg');
    const generateBtn = document.getElementById('generateBtn');
    const outputSection = document.getElementById('output-section');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');

    // Controls
    const applicationType = document.getElementById('applicationType');
    const employmentStatus = document.getElementById('employmentStatus');
    const isSponsored = document.getElementById('isSponsored');
    const visaType = document.getElementById('visaType');
    const visaTypeOther = document.getElementById('visaTypeOther');
    const funding = document.getElementById('funding');
    const fundingOther = document.getElementById('fundingOther');

    // Blocks
    const sponsorBlock = document.getElementById('sponsorBlock');
    const refusalBlock = document.getElementById('refusalBlock');
    const businessBlock = document.getElementById('businessBlock');
    const medicalBlock = document.getElementById('medicalBlock');

    // Fields
    const visaRefusals = document.getElementById('visaRefusals');
    const businessDetails = document.getElementById('businessDetails');
    const medicalDetails = document.getElementById('medicalDetails');
    const sponsorName = document.getElementById('sponsorName');
    const sponsorRelationship = document.getElementById('sponsorRelationship');
    const sponsorReqBadges = document.querySelectorAll('.sponsor-req');

    const monthlyExpenses = document.getElementById('monthlyExpenses');
    const currentBankBalance = document.getElementById('currentBankBalance');
    const estimatedTripCost = document.getElementById('estimatedTripCost');
    const financeCalc = document.getElementById('financeCalc');

    // Helpers
    function setRequired(el, on) {
      if (!el) return;
      if (on) el.setAttribute('required','required'); else el.removeAttribute('required');
    }
    function show(el, on){ el.classList.toggle('hidden', !on); }
    function v(id){ return document.getElementById(id)?.value?.trim() || '' }
    function num(x){ if(!x) return NaN; const s=(''+x).replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return isNaN(n)?NaN:n; }

    // Conditional UI
    applicationType.addEventListener('change', () => {
      const reapp = applicationType.value === 'Reapplication';
      show(refusalBlock, reapp);
      setRequired(visaRefusals, reapp);
    });

    isSponsored.addEventListener('change', () => {
      const on = isSponsored.value === 'Yes';
      show(sponsorBlock, on);
      setRequired(sponsorName, on);
      setRequired(sponsorRelationship, on);
      sponsorReqBadges.forEach(b=>b.classList.toggle('hidden', !on));
    });

    visaType.addEventListener('change', () => {
      const v = visaType.value;
      show(businessBlock, v === 'Business');
      setRequired(businessDetails, v === 'Business');

      show(medicalBlock, v === 'Medical');
      setRequired(medicalDetails, v === 'Medical');

      show(visaTypeOther, v === 'Other');
      setRequired(visaTypeOther, v === 'Other');
    });

    funding.addEventListener('change', () => {
      const on = funding.value === 'Other';
      show(fundingOther, on);
      setRequired(fundingOther, on);
    });

    // Live finance calculation (just guidance text)
    [monthlyExpenses, estimatedTripCost, currentBankBalance, document.getElementById('income')].forEach(el=>{
      el.addEventListener('input', showFinance);
    });
    function showFinance(){
      const income = num(v('income'));
      const expenses = num(v('monthlyExpenses'));
      const trip = num(v('estimatedTripCost'));
      const balance = num(v('currentBankBalance'));
      if([income,expenses,trip,balance].every(Number.isNaN)){
        financeCalc.classList.add('hidden'); financeCalc.textContent=''; return;
      }
      const disp = (isNaN(income)?0:income) - (isNaN(expenses)?0:expenses);
      const ratio = isNaN(trip) || disp<=0 ? null : (trip/disp);
      const remain = isNaN(balance) || isNaN(trip) ? null : (balance - trip);
      financeCalc.classList.remove('hidden');
      financeCalc.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
          <div><span class="font-semibold">Disposable Income (≈):</span> ${isNaN(disp)?'—':disp.toLocaleString()}</div>
          <div><span class="font-semibold">Trip/Disposable Ratio:</span> ${ratio===null?'—':ratio.toFixed(2)} ${ratio!==null? (ratio<=1?'(Looks affordable)':'(May require sponsor/assets)'):''}</div>
          <div><span class="font-semibold">Balance after Trip (≈):</span> ${remain===null?'—':remain.toLocaleString()}</div>
        </div>`;
    }

    // Data collection
    function getFormData(){
      // Merge special purpose blocks into specialEvents
      let special = v('specialEvents');
      const vt = visaType.value === 'Other' ? `Other (${v('visaTypeOther')})` : visaType.value;
      if(vt === 'Business' && v('businessDetails')) special += (special?'\n':'') + `Business/Conference: ${v('businessDetails')}`;
      if(vt === 'Medical' && v('medicalDetails')) special += (special?'\n':'') + `Medical: ${v('medicalDetails')}`;

      // “Other” funding normalized
      const fundingValue = funding.value === 'Other' && v('fundingOther')
        ? `Other: ${v('fundingOther')}`
        : (funding.value || '');

      // Finance synthesis appended to bankStatementDetails
      const bits = [];
      if(v('income')) bits.push(`Monthly Income: ${v('income')}`);
      if(v('monthlyExpenses')) bits.push(`Monthly Expenses: ${v('monthlyExpenses')}`);
      if(v('currentBankBalance')) bits.push(`Current Bank Balance: ${v('currentBankBalance')}`);
      if(v('estimatedTripCost')) bits.push(`Estimated Trip Cost: ${v('estimatedTripCost')}`);
      if(applicationType.value) bits.push(`Application Type: ${applicationType.value}`);
      if(employmentStatus.value) bits.push(`Employment Status: ${employmentStatus.value}`);
      if(isSponsored.value) bits.push(`Sponsored: ${isSponsored.value}`);
      const bankSynth = [v('bankStatementDetails'), bits.join(' • ')].filter(Boolean).join('\n');

      return {
        // Personal
        name: v('name'),
        age: v('age'),
        nationality: v('nationality'),
        applicantAddress: v('applicantAddress'),
        contactPhone: v('contactPhone'),
        contactEmail: v('contactEmail'),
        dateOfBirth: v('dateOfBirth'),
        passportNumber: v('passportNumber'),
        passportIssueDate: v('passportIssueDate'),
        passportExpiryDate: v('passportExpiryDate'),
        maritalStatus: v('maritalStatus'),
        numDependents: v('numDependents'),

        // Travel
        destination: v('destination'),
        visaType: vt,
        purpose: v('purpose'),
        travelDates: v('travelDates'),
        entryDate: v('entryDate'),
        stayDuration: v('stayDuration'),
        invited: v('invited'),
        inviterName: v('inviterName'),
        inviterAddress: v('inviterAddress'),
        inviterRelationship: v('inviterRelationship'),
        inviterDocs: v('inviterDocs'),
        stayDetails: v('stayDetails'),
        travelItinerary: v('travelItinerary'),

        // Employment & finances
        occupation: v('occupation'),
        employerName: v('employerName'),
        employerAddress: v('employerAddress'),
        employmentDuration: v('employmentDuration'),
        income: v('income'),
        otherIncome: v('otherIncome'),
        funding: fundingValue,
        bankStatementDetails: bankSynth,
        significantTransactions: v('significantTransactions'),
        monthlyExpenses: v('monthlyExpenses'),
        currentBankBalance: v('currentBankBalance'),
        estimatedTripCost: v('estimatedTripCost'),

        // Consular/logistics
        accommodation: v('stayDetails') || v('accommodation'),
        documents: v('documents'),
        embassyName: v('embassyName'),
        embassyAddress: v('embassyAddress'),
        companyName: v('companyName') || 'No Guide Travel Agent',

        // Ties
        propertyDetails: v('propertyDetails'),
        businessCommitments: v('businessCommitments'),
        familyDependents: v('familyDependents'),
        otherCommitments: v('otherCommitments'),

        // History
        travelHistory: v('travelHistory'),
        visaRefusals: (applicationType.value==='Reapplication' ? (v('visaRefusals') || 'Refusal stated but details not provided') : v('visaRefusals')),
        validVisas: v('validVisas'),

        // Sponsor
        sponsorSelf: (isSponsored.value==='Yes' ? 'No' : 'Yes'),
        sponsorName: v('sponsorName'),
        sponsorRelationship: v('sponsorRelationship'),
        sponsorOccupation: v('sponsorOccupation'),
        sponsorIncome: v('sponsorIncome'),
        sponsorAccommodation: v('sponsorAccommodation'),
        sponsorDocs: v('sponsorDocs'),

        // Additional
        specialEvents: special,
        compellingReasons: v('compellingReasons'),
        supportingLetters: v('supportingLetters'),
        potentialWeaknesses: v('potentialWeaknesses')
      };
    }

    function validateForm(data){
      const missing = [];
      if(!data.name) missing.push('Name');
      if(!data.age) missing.push('Age');
      if(!data.nationality) missing.push('Nationality');
      if(!data.destination) missing.push('Destination Country');
      if(!visaType.value) missing.push('Visa Type');
      if(visaType.value==='Other' && !v('visaTypeOther')) missing.push('Visa Type (Other explanation)');
      if(!data.purpose) missing.push('Purpose of Travel');
      if(!data.income) missing.push('Monthly Income');
      if(!applicationType.value) missing.push('Application Type');
      if(!employmentStatus.value) missing.push('Employment Status');
      if(!isSponsored.value) missing.push('Sponsored?');
      if(applicationType.value==='Reapplication' && !v('visaRefusals')) missing.push('Refusal Reasons');
      if(isSponsored.value==='Yes'){
        if(!v('sponsorName')) missing.push('Sponsor Name');
        if(!v('sponsorRelationship')) missing.push('Sponsor Relationship');
      }
      if(visaType.value==='Business' && !v('businessDetails')) missing.push('Business/Conference Details');
      if(visaType.value==='Medical' && !v('medicalDetails')) missing.push('Medical Details');
      if(funding.value==='Other' && !v('fundingOther')) missing.push('Funding Source (Other explanation)');
      return missing;
    }

    async function generateLetter(payload){
      const response = await fetch('https://visa-cover-letter-api.onrender.com/generate-letter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!response.ok){
        const errorData = await response.json().catch(()=>null);
        throw new Error(errorData?.error || 'Unexpected server error');
      }
      const data = await response.json();
      return data.letter;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = getFormData();
      const missing = validateForm(payload);
      if(missing.length){
        statusMsg.textContent = `Missing required fields: ${missing.join(', ')}`;
        statusMsg.classList.add('text-red-600');
        return;
      }
      statusMsg.textContent = '';
      spinner.classList.remove('hidden');
      generateBtn.disabled = true;
      try{
        const letter = await generateLetter(payload);
        output.value = letter;
        outputSection.classList.remove('hidden');
        statusMsg.textContent = 'Letter generated successfully';
        statusMsg.classList.remove('text-red-600');
        statusMsg.classList.add('text-green-600');
      }catch(err){
        console.error(err);
        statusMsg.textContent = err.message || 'Failed to generate letter';
        statusMsg.classList.add('text-red-600');
      }finally{
        spinner.classList.add('hidden');
        generateBtn.disabled = false;
      }
    });

    // Utilities
    copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(output.value); alert('Letter copied to clipboard'); } catch{ alert('Could not copy'); } });
    downloadBtn.addEventListener('click', ()=>{ const blob = new Blob([output.value], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'visa_cover_letter.doc'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); });
    printBtn.addEventListener('click', ()=>{ const win = window.open('', '_blank'); if(!win) return; win.document.write(`<!doctype html><html><head><title>Visa Cover Letter</title></head><body style="white-space: pre-wrap; font-family: serif; margin: 40px;">${output.value.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</body></html>`); win.document.close(); win.focus(); win.print(); });

  </script>
</body>
</html>
